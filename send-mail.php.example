<?php
/**
 * Example Send Mail Script - COPY THIS FILE TO send-mail.php AND UPDATE AS NEEDED
 * This script demonstrates how to send emails using PHPMailer
 */

require 'PHPMailer/PHPMailer.php';
require 'PHPMailer/SMTP.php';
require 'PHPMailer/Exception.php';

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

// Set the content type to JSON
header('Content-Type: application/json');

$mail = new PHPMailer(true);

try {
    // Server settings
    $mail->isSMTP();
    $mail->Host       = SMTP_HOST;       // SMTP server
    $mail->SMTPAuth   = true;            // Enable SMTP authentication
    $mail->Username   = SMTP_USERNAME;   // SMTP username
    $mail->Password   = SMTP_PASSWORD;   // SMTP password
    $mail->SMTPSecure = SMTP_SECURE;     // Enable TLS encryption; `ssl` also accepted
    $mail->Port       = SMTP_PORT;       // TCP port to connect to

    // Recipients
    $mail->setFrom(EMAIL_FROM, EMAIL_NAME);
    $mail->addAddress(ADMIN_EMAIL);      // Add a recipient
    
    // Optional: Add reply-to from form data
    if (!empty($_POST['email'])) {
        $mail->addReplyTo($_POST['email'], $_POST['name'] ?? '');
    }

    // Content
    $mail->isHTML(true);                 // Set email format to HTML
    $mail->Subject = $_POST['subject'] ?? 'New contact form submission';
    
    // Build email body
    $body = "<h2>Contact Form Submission</h2>";
    $body .= "<p><strong>Name:</strong> " . htmlspecialchars($_POST['name'] ?? 'Not provided') . "</p>";
    $body .= "<p><strong>Email:</strong> " . htmlspecialchars($_POST['email'] ?? 'Not provided') . "</p>";
    $body .= "<p><strong>Subject:</strong> " . htmlspecialchars($_POST['subject'] ?? 'Not provided') . "</p>";
    $body .= "<p><strong>Message:</strong></p>";
    $body .= "<p>" . nl2br(htmlspecialchars($_POST['message'] ?? 'No message')) . "</p>";
    
    $mail->Body = $body;
    
    // Send the email
    $mail->send();
    
    // Return success JSON response
    echo json_encode([
        'status' => 'success', 
        'message' => 'Your message has been received. Thank you for contacting us!'
    ]);
    
} catch (Exception $e) {
    // Log the error (optional)
    error_log("Email sending failed: " . $mail->ErrorInfo);
    
    // Return error JSON response
    http_response_code(500);
    echo json_encode([
        'status' => 'error', 
        'message' => 'Failed to send email. Please try again later.'
    ]);
}